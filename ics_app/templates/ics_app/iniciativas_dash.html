{% load static %}
{% load formatadores %}
{% now "U" as now %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Iniciativas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'ics_app/css/style.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body class="container-fluid p-4 stellantis-dark">

  <a href="{% url 'home' %}?main_tab=Iniciativa&sub_tab=dados_iniciativa" class="btn btn-back-light btn-sm mb-4">
    ← Voltar para Iniciativas
  </a>

  <h2 class="mb-4">Dashboard – Iniciativas</h2>

  <form method="get" class="mb-4 d-flex align-items-center gap-2">
    <label for="iniciativa" class="form-label mb-0"><strong>Selecione a(s) Iniciativa(s):</strong></label>
    <select name="iniciativa" id="iniciativa-select2" class="form-select form-select-sm" style="width:300px;" multiple>
      {% for ini in todas_iniciativas %}
        <option value="{{ ini }}"
          {% if iniciativa_selecionada and ini in iniciativa_selecionada %}selected{% endif %}>{{ ini }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary btn-sm ms-2">Filtrar</button>
  </form>

  {% if iniciativa_selecionada %}
    <h5 class="mb-4">Iniciativas Selecionadas:
      <strong>
        {% for ini in iniciativa_selecionada %}
          {{ ini }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </strong>
    </h5>
  {% else %}
    <h5 class="mb-4">Nenhuma Iniciativa Selecionada</h5>
  {% endif %}

  <div class="row text-center mb-5">
    <div class="col-3 mb-3">
      <div class="card shadow-sm p-6">
        <h6 class="text-muted">Total de Iniciativas</h6>
        <h2 class="fw-bold">{{ total_iniciativas }}</h2>
      </div>
    </div>
    <div class="col-3 mb-3">
      <div class="card shadow-sm p-6">
        <h6 class="text-muted">Valor Total</h6>
        <h2 class="fw-bold">{{ total_orcamento|moeda_brasileira }}</h2>
      </div>
    </div>
    <div class="col-3 mb-6">
      <div class="card shadow-sm p-6">
        <h6 class="text-muted">Ano(s) Cadastrados</h6>
        <h2 class="fw-bold">
          {% for a in anos %}{{ a }}{% if not forloop.last %}, {% endif %}{% endfor %}
        </h2>
      </div>
    </div>
    <div class="col-3 mb-6">
      <div class="card shadow-sm p-6">
        <h6 class="text-muted">Status</h6>
        <h2 class="fw-bold">
          {% for st, qtd in status_counts.items %}
            {{ st }}: {{ qtd }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </h2>
      </div>
    </div>
  </div>

  <div class="row mb-5">
    <div class="col-12">
      <div class="stellantis-card" style="height:auto; min-height:auto;">
        <h6 class="text-center mb-3">
          Distribuição dos Valores por Iniciativa
        </h6>
        <canvas id="graficoIniciativasValores" style="height:auto !important; max-height:auto; width:90%;"></canvas>
        <div class="table-responsive mt-4">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>RDA</th>
                <th>Pedido</th>
                <th>Data</th>
                <th>Fornecedor</th>
                <th>Preço Líq.</th>
                <th>Valor Bruto</th>
              </tr>
            </thead>
            <tbody>
              {% for pedido in pedidos_iniciativa %}
              <tr>
                <td>{{ pedido.requisicao_compras }}</td>
                <td>{{ pedido.doc_compra }}</td>
                <td>{{ pedido.data_documento|date:"d/m/Y" }}</td>
                <td>{{ pedido.razao_social }}</td>
                <td>{{ pedido.preco_liquido|moeda_brasileira }}</td>
                <td>{{ pedido.montante|moeda_brasileira }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center">Nenhum pedido encontrado.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script>
      window.graficoIniciativasConfig = {
        labels: {{ grafico_iniciativas_labels|safe }},
        consumido: {{ grafico_iniciativas_consumido|safe }},
        proposto: {{ grafico_iniciativas_proposto|safe }},
        livre: {{ grafico_iniciativas_livre|safe }}
      };
    </script>
    <script src="{% static 'ics_app/js/chart_config.js' %}"></script>
    <script>
      $(document).ready(function() {
        $('#iniciativa-select2').select2({
        placeholder: "Digite ou escolha...",
        allowClear: true,
        width: 'resolve',
        textColor: '#000',
        dropdownAutoWidth: true,
        language: "pt-BR"
      });
      // Submete automaticamente ao escolher (Select2 não propaga onchange padrão)
      $('#iniciativa-select2').on('change', function(){
        this.form.submit();
      });
    });
  </script>
</body>
</html>
